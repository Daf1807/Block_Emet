<!DOCTYPE html>
<html lang="es">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Registro Pedidos - El Misti</title>

<style>
:root{
  --rojo:#8B0000;
  --amarillo:#FFC107;
  --bg:#f4f6f9;
  --card:#ffffff;
  --gris-suave:#f8f9fa;
}


body{
  font-family: 'Poppins', sans-serif;
  margin:0;
  background: linear-gradient(135deg,#f4f6f9,#e9edf3);
}


/* HEADER */
header{
  background:var(--rojo);
  color:white;
  padding:14px;
  text-align:center;
  font-size:20px;
  font-weight:bold;
}

/* SECCIONES */
section{ padding:12px }

.card{
  background:var(--card);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  transition:transform .2s ease, box-shadow .2s ease;
}

.card:hover{
  transform:translateY(-3px);
  box-shadow:0 12px 25px rgba(0,0,0,.12);
}


h2{
  color:var(--rojo);
  margin:8px 0;
}

/* PLATOS */
.item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 0;
  border-bottom:1px solid #eee;
}

.controls{
  display:flex;
  gap:8px;
  align-items:center;
}

.qty{
  width:35px;
  text-align:center;
  font-weight:bold;
  border:none;
  font-size:16px;
}

/* BOTONES */
button{
  border:none;
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  transition:all .2s ease;
}

button:hover{
  transform:scale(1.05);
  opacity:.9;
}

.btn{
  background:var(--rojo);
  color:white;
}

.big{
  width:100%;
  padding:14px;
  background:var(--amarillo);
  font-weight:bold;
  font-size:18px;
}

/* PEDIDOS */
.pedido{
  background:white;
  border-left:6px solid var(--rojo);
  padding:14px;
  margin-bottom:14px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.06);
  transition:all .2s ease;
}

.pedido:hover{
  transform:scale(1.01);
}


/* GRID PC */
@media(min-width:700px){
  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
}

.timer-box{
  display:inline-block;
  padding:6px 12px;
  border-radius:8px;
  font-weight:bold;
  font-size:16px;
  transition:all .3s ease;
}

.timer-green{
  background:#d4edda;
  color:#155724;
}

.timer-orange{
  background:#fff3cd;
  color:#856404;
}

.timer-red{
  background:#f8d7da;
  color:#721c24;
  animation:parpadeo 1s infinite;
}

@keyframes parpadeo{
  0%{opacity:1}
  50%{opacity:.5}
  100%{opacity:1}
}

.progress-bar{
  height:6px;
  background:#eee;
  border-radius:4px;
  margin-top:6px;
  overflow:hidden;
}

.progress-fill{
  height:100%;
  width:0%;
  background:#28a745;
  transition:width .5s linear;
}

.colIni{
  width:75px;
  padding:8px;
  border-radius:10px;
  border:2px solid #e0e0e0;
  font-weight:600;
  text-align:center;
  background:#f8f9fa;
  font-size:15px;
  transition:all .25s ease;
  outline:none;
}

/* Hover */
.colIni:hover{
  border-color:#bdbdbd;
  transform:scale(1.05);
}

/* Cuando est√° activo */
.colIni:focus{
  border-color:#4CAF50;
  box-shadow:0 0 0 3px rgba(76,175,80,.2);
  background:white;
  transform:scale(1.07);
}

/* Cuando tiene n√∫mero diferente de 0 */
.colIni:not([value="0"]){
  border-color:#4CAF50;
  background:#f1fff4;
}

  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button{
    opacity:1;
  }

.nombrePlato{
  flex:1;
  padding:10px 12px;
  font-size:17px;
  font-weight:600;
  border-radius:12px;
  border:2px solid #e0e0e0;
  background:#ffffff;
  transition:all .25s ease;
  outline:none;
}

/* Hover */
.nombrePlato:hover{
  border-color:#bdbdbd;
}

/* Cuando escribes */
.nombrePlato:focus{
  border-color:#2196F3;
  box-shadow:0 0 0 3px rgba(33,150,243,.2);
  background:#fff;
}

.filaMenu{
  display:flex;
  gap:10px;
  align-items:center;
}

#tipo{
  display:none;
}

.tipoSelector{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.tipoSelector button{
  flex:1;
  padding:10px;
  font-size:16px;
  font-weight:600;
  border-radius:12px;
  border:2px solid #e0e0e0;
  background:#ffffff;
  cursor:pointer;
  transition:all .25s ease;
}

.tipoSelector button:hover{
  border-color:#bdbdbd;
  transform:scale(1.03);
}

.tipoSelector button.activo{
  background:#4CAF50;
  color:white;
  border-color:#4CAF50;
  box-shadow:0 0 0 3px rgba(76,175,80,.2);
}


</style>
</head>

<body>

<header>üçΩÔ∏è EL MISTI - Registro de Pedidos</header>

<section>

<div class="card">
Tipo:
<select id="tipo" onchange="guardarTipo()">
  <option value="mesa">Mesa</option>
  <option value="llevar">Llevar</option>
  <option value="reserva">Reserva</option>
</select>

<div class="tipoSelector">
  <button type="button" onclick="cambiarTipo('mesa')" id="btnMesa">Mesa</button>
  <button type="button" onclick="cambiarTipo('llevar')" id="btnLlevar">Llevar</button>
  <button type="button" onclick="cambiarTipo('reserva')" id="btnReserva">Reserva</button>
</div>


Mesa / Nombre:
<input id="mesa" style="width:100%">
<div id="mesasBotones" style="margin-top:10px;display:none;"></div>

</div>

<div class="grid">

<div class="card">
<h2>Entradas</h2>

<div style="display:flex;align-items:center;gap:6px;font-weight:bold;margin-bottom:6px">

  <button onclick="toggleIni('entradas')" 
          style="padding:2px 6px;border-radius:6px">
    üëÅ
  </button>

  <div class="colIni" style="width:60px">Ini</div>
  <div style="width:80px">Disp</div>
  <div style="flex:1">Entradas</div>

</div>


<div id="entradas"></div>
</div>


<div class="card">
<h2>Segundos</h2>

<div style="display:flex;align-items:center;gap:6px;font-weight:bold;margin-bottom:6px">

  <button onclick="toggleIni('segundos')" 
          style="padding:2px 6px;border-radius:6px">
    üëÅ
  </button>

  <div class="colIni" style="width:60px">Ini</div>
  <div style="width:80px">Disp</div>
  <div style="flex:1">Segundos</div>

</div>


<div id="segundos"></div>
</div>

</div>

<!-- EXTRAS COMIDA -->
<div class="card">
<h2>üç≥ Extras comida</h2>
<div id="extrasComida"></div>
</div>

<!-- ENVASES -->
<div class="card">
<h2>ü•° Envases para llevar</h2>
<div id="envases"></div>
</div>

<!-- DELIVERY -->
<div class="card">
<h2>üöö Delivery</h2>
Costo adicional:
<input type="number" id="deliveryCosto" value="0" min="0" step="0.5" style="width:80px"> soles
</div>

<div class="card" style="text-align:center;font-size:22px;font-weight:700;color:#2c3e50">
  üí∞ Total actual: <b id="totalPreview">S/ 0.00</b>
</div>


<button class="big" onclick="registrarPedido()">‚úÖ Registrar pedido</button>

<button class="btn" onclick="resetearDisponibles()" style="margin-top:10px;width:100%">
üîÑ Resetear DISP
</button>

<button class="btn" onclick="eliminarTodo()" 
style="margin-top:10px;width:100%;background:black">
üóëÔ∏è Eliminar TODOS los pedidos
</button>



<h2>üìã Pedidos del d√≠a</h2>

<!-- MESA -->
<div class="card">
  <h3>
    üçΩÔ∏è Mesa 
    <button class="btn" onclick="descargarWordTipo('mesa')">
      üìÑ Imprimir
    </button>
  </h3>
  <div id="seccion_mesa"></div>
</div>

<!-- RESERVA -->
<div class="card">
  <h3>
    üìÖ Reserva 
    <button class="btn" onclick="descargarWordTipo('reserva')">
      üìÑ Imprimir
    </button>
  </h3>
  <div id="seccion_reserva"></div>
</div>

<!-- LLEVAR -->
<div class="card">
  <h3>
    ü•° Llevar 
    <button class="btn" onclick="descargarWordTipo('llevar')">
      üìÑ Imprimir
    </button>
  </h3>
  <div id="seccion_llevar"></div>
</div>



</section>

<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>


<script>

  // üî• CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyCakBN0YRTOGCKVQ7A5iLKksNh0cjF-JOg",
  authDomain: "el-misti-pedidos.firebaseapp.com",
  projectId: "el-misti-pedidos",
  storageBucket: "el-misti-pedidos.firebasestorage.app",
  messagingSenderId: "337950171428",
  appId: "1:337950171428:web:7a8124d45ec9e44fbe13b1",
  measurementId: "G-3VSKDP2KF9"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =================================================
   CANTIDADES FIJAS (LO √öNICO NUEVO)
================================================= */
const TOTAL_ENTRADAS = 5;
const TOTAL_SEGUNDOS = 10;


/* =================================================
   EXTRAS Y ENVASES (INTOCABLES ‚Äì IGUAL QUE TUYO)
================================================= */
const extrasComida=[
 {nombre:"Arroz extra",precio:2},
 {nombre:"Presa adicional",precio:5},
 {nombre:"Vaso adicional",precio:1},
 {nombre:"Medio vaso refresco",precio:0.5}
];

const envases=[
 {nombre:"Taper grande",precio:1},
 {nombre:"Taper chico",precio:0.5}
];

let pedidos = [];

db.collection("pedidos").doc("diaActual")
.onSnapshot((doc) => {
  if(doc.exists){
    pedidos = doc.data().lista || [];
    mostrar();
  }
});

/* =================================================
   NUEVO: CREAR ENTRADAS/SEGUNDOS EDITABLES
   (MISMO DISE√ëO .item .controls .qty)
================================================= */
function crearMenuEditable(total, cont, prefijo){

  const div=document.getElementById(cont);

  for(let i=0;i<total;i++){

    const key=prefijo+i;
    const nombreGuardado =
      localStorage.getItem(key+"-nombre") || "";
    const inicialGuardado = localStorage.getItem(key+"-inicial") || 0;
    const vendidoGuardado = localStorage.getItem(key+"-vendido") || 0;
    const disponible = inicialGuardado - vendidoGuardado;

    div.innerHTML+=`
  <div class="item" style="display:flex;align-items:center;gap:10px">

    <!-- INICIAL -->
    <input
      class="colIni"
      type="number"
      value="${inicialGuardado}"
      min="0"
      oninput="
        localStorage.setItem('${key}-inicial',this.value);
        actualizarDisponible('${key}');
      "
    >




    <!-- DISPONIBLE -->
    <span
      id="disp_${key}"
      style="width:60px;text-align:center;font-weight:bold;color:${disponible<=0?'red':'black'}">
      ${disponible}
    </span>


    <!-- NOMBRE -->
    <input
      class="nombrePlato"
      value="${nombreGuardado}"
      placeholder="Nombre..."
      oninput="localStorage.setItem('${key}-nombre',this.value)"
      style="flex:1"
    >

    <!-- CONTROLES -->
    <div class="controls">

      <button onclick="cambiar('${key}',-1)">-</button>

      <input class="qty" id="${key}" value="0" readonly>

      <button onclick="cambiar('${key}',1)">+</button>

      <!-- BOT√ìN NOTA -->
      <button 
        type="button"
        onclick="toggleNota('${key}')"
        style="
          background:#eee;
          padding:6px 8px;
          border-radius:6px;
          font-size:12px;
        ">
        üìù
      </button>

    </div>

  </div>

  <!-- NOTA OCULTA -->
  <input
    id="nota_${key}"
    placeholder="Nota (sin arroz, sin papa, etc)"
    style="
      display:none;
      margin-top:5px;
      font-size:12px;
      padding:4px;
      border:1px solid #ddd;
      border-radius:6px;
      width:100%;
    ">
`;

  }
}





/* =================================================
   CREAR ITEMS (AHORA CON NOTA POR PLATO)
================================================= */
function crearItems(lista, cont){
  const div=document.getElementById(cont);

  lista.forEach(i=>{
    const nombre=i.nombre||i;

    div.innerHTML+=`
      <div class="item">
        ${nombre} ${i.precio?`(S/ ${i.precio})`:""}
        <div class="controls">
          <button onclick="cambiar('${nombre}',-1)">-</button>
          <input class="qty" id="${nombre}" value="0" readonly>
          <button onclick="cambiar('${nombre}',1)">+</button>
        </div>
      </div>`;
  });
}




/* =================================================
   + / -  (TUYO)
================================================= */
function cambiar(id,n){
  const el=document.getElementById(id);
  let v=parseInt(el.value)+n;
  if(v<0)v=0;
  el.value=v;
  calcularPreview(); // üëà agregado
}


function calcularPreview(){

  let total=0;
  let ent=0, seg=0;

  // contar entradas
  for(let i=0;i<TOTAL_ENTRADAS;i++){
    ent += +document.getElementById("E"+i).value;
  }

  // contar segundos
  for(let i=0;i<TOTAL_SEGUNDOS;i++){
    seg += +document.getElementById("S"+i).value;
  }

  const menus=Math.min(ent,seg);

  total+=menus*13;
  total+=(seg-menus)*10;
  total+=(ent-menus)*5;

  // extras
  extrasComida.forEach(e=>{
    total += +document.getElementById(e.nombre).value * e.precio;
  });

  // envases
  envases.forEach(e=>{
    total += +document.getElementById(e.nombre).value * e.precio;
  });

  // delivery
  total += +deliveryCosto.value;

  totalPreview.innerText="S/ "+total.toFixed(2);
}

function toggleNota(id){

  const campo = document.getElementById("nota_"+id);

  if(campo.style.display === "none"){
    campo.style.display = "block";
    campo.focus();
  } else {
    campo.style.display = "none";
  }

}

function actualizarDisponible(key){

  const inicial = +localStorage.getItem(key+"-inicial") || 0;
  const vendido = +localStorage.getItem(key+"-vendido") || 0;

  let disponible = inicial - vendido;
  if(disponible < 0) disponible = 0;

  const span = document.getElementById("disp_"+key);
  if(span){
    span.innerText = disponible;
    span.style.color = disponible <= 0 ? "red" : "black";
  }

  // bloquear bot√≥n +
  const btnMas = document.querySelector(
    `button[onclick="cambiar('${key}',1)"]`
  );

  if(btnMas){
    btnMas.disabled = disponible <= 0;
    btnMas.style.opacity = disponible <= 0 ? 0.3 : 1;
  }
}

/* üî• FUNCI√ìN PARA MOSTRAR / OCULTAR COLUMNA INI */
function toggleIni(seccion){

  const container = document.getElementById(seccion);
  const card = container.closest(".card");
  const columnas = card.querySelectorAll(".colIni");

  let oculto = columnas[0].style.display !== "none";

  columnas.forEach(col=>{
    col.style.display = oculto ? "none" : "";
  });

  // üî• guardar estado
  localStorage.setItem("iniOculto_"+seccion, oculto ? "1" : "0");
}

function guardarTipo(){

  const selectTipo = document.getElementById("tipo");
  const tipo = selectTipo.value;

  localStorage.setItem("tipoSeleccionado", tipo);

  const contenedor = document.getElementById("mesasBotones");

  if(tipo === "mesa"){
    contenedor.style.display = "block";
    generarBotonesMesas();
  }else{
    contenedor.style.display = "none";
  }
}


function generarBotonesMesas(){

  const contenedor = document.getElementById("mesasBotones");
  contenedor.innerHTML = "";

  for(let i=1;i<=25;i++){

    contenedor.innerHTML += `
      <button 
        type="button"
        onclick="seleccionarMesa(${i})"
        style="
          margin:4px;
          padding:8px 12px;
          border-radius:8px;
          background:#eee;
        ">
        ${i}
      </button>
    `;
  }
}

function seleccionarMesa(numero){
  document.getElementById("mesa").value = numero;
}


function eliminarTodo(){

  if(!confirm("¬øEliminar TODOS los pedidos del d√≠a?")) return;

  pedidos = [];
  localStorage.removeItem("pedidosMisti");

  mostrar();

  alert("Todos los pedidos fueron eliminados");
}

function cambiarTipo(valor){

  const select = document.getElementById("tipo");
  select.value = valor;

  // dispara tu funci√≥n original
  guardarTipo();

  actualizarBotonesTipo();
}

function actualizarBotonesTipo(){

  const valor = document.getElementById("tipo").value;

  document.querySelectorAll(".tipoSelector button")
    .forEach(btn => btn.classList.remove("activo"));

  if(valor === "mesa") document.getElementById("btnMesa").classList.add("activo");
  if(valor === "llevar") document.getElementById("btnLlevar").classList.add("activo");
  if(valor === "reserva") document.getElementById("btnReserva").classList.add("activo");
}




/* =================================================
   REGISTRAR (MISMA L√ìGICA + solo cambio de lectura)
================================================= */
function registrarPedido(){

  let total=0;
  let ent=0, seg=0;

  let detalleEntradas=[];
  let detalleSegundos=[];
  let detalleExtras=[];
  let detalleEnvases=[];

  /* ENTRADAS */
  for(let i=0;i<TOTAL_ENTRADAS;i++){
    const nombre=localStorage.getItem("E"+i+"-nombre");
    const c=+document.getElementById("E"+i).value;

    if(nombre && c>0){

      const nota=document.getElementById("nota_E"+i)?.value || "";

      let texto=`${c} - ${nombre}`;
      let vendidoActual = +localStorage.getItem("E"+i+"-vendido") || 0;
      localStorage.setItem("E"+i+"-vendido", vendidoActual + c);
      actualizarDisponible("E"+i);

      if(nota) texto+=` | NOTA: ${nota.toUpperCase()}`;

      detalleEntradas.push(texto);
      ent+=c;
    }

  }

  /* SEGUNDOS */
  for(let i=0;i<TOTAL_SEGUNDOS;i++){
    const nombre=localStorage.getItem("S"+i+"-nombre");
    const c=+document.getElementById("S"+i).value;

    if(nombre && c>0){

      const nota=document.getElementById("nota_S"+i)?.value || "";

      let texto=`${c} - ${nombre}`;
      let vendidoActual = +localStorage.getItem("S"+i+"-vendido") || 0;
      localStorage.setItem("S"+i+"-vendido", vendidoActual + c);
      actualizarDisponible("S"+i);

      if(nota) texto+=` | NOTA: ${nota.toUpperCase()}`;

      detalleSegundos.push(texto);
      seg+=c;
    }

  }

  const menus=Math.min(ent,seg);

  total+=menus*13;
  total+=(seg-menus)*10;
  total+=(ent-menus)*5;

  /* EXTRAS (IGUAL) */
  extrasComida.forEach(e=>{
    const c=+document.getElementById(e.nombre).value;
    if(c>0){
      detalleExtras.push(`${c} - ${e.nombre}`);
      total+=c*e.precio;
    }
  });

  /* ENVASES (IGUAL) */
  envases.forEach(e=>{
    const c=+document.getElementById(e.nombre).value;
    if(c>0){
      detalleEnvases.push(`${c} - ${e.nombre}`);
      total+=c*e.precio;
    }
  });

  const delivery=+deliveryCosto.value;
  total+=delivery;

if(detalleEntradas.length===0 && detalleSegundos.length===0){
  alert("No hay platos en el pedido");
  return;
}


const tipoActual = document.getElementById("tipo").value;

let horaExacta = null;
let timestamp = null;

if(tipoActual === "mesa"){
  const ahora = new Date();

  // Hora bonita para mostrar
  horaExacta = ahora.toLocaleTimeString("es-PE", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  });

  // Tiempo real en milisegundos (para el temporizador)
  timestamp = Date.now();
}


pedidos.push({
  tipo: tipoActual,
  mesa: document.getElementById("mesa").value,
  hora: horaExacta, // solo tendr√° valor si es mesa
  horaRegistro: timestamp, // ‚¨ÖÔ∏è NUEVO (para el temporizador)
  atendido: false, // ‚¨ÖÔ∏è NUEVO (para saber si ya se complet√≥)
  colapsado: false, // üëà NUEVO
  detalleEntradas: detalleEntradas,
  detalleSegundos: detalleSegundos,
  detalleExtras: detalleExtras,
  detalleEnvases: detalleEnvases,
  total: total,
});




  guardarHistorial();
  mostrar();
  reset();
}


/* =================================================
   TODO LO DEM√ÅS IGUAL (MOSTRAR / ELIMINAR / ETC)
================================================= */

function mostrar(){

  console.log("Array pedidos actual:", pedidos);

  let htmlMesa="";
  let htmlReserva="";
  let htmlLlevar="";

  // üî• ORDEN VISUAL SEGURO (sin tocar el array)
  const ordenIndices = [
    ...pedidos.map((p,i)=> !p.atendido ? i : null).filter(i=>i!==null),
    ...pedidos.map((p,i)=> p.atendido ? i : null).filter(i=>i!==null)
  ];

  ordenIndices.forEach((i)=>{

    const p = pedidos[i];

    let bloque=`
    <div class="pedido" id="pedido_${i}">

    <b>
    #${i+1} | ${p.tipo.toUpperCase()} | ${(p.mesa||"-").toUpperCase()}
    ${p.tipo === "mesa" && p.hora ? ` | üïí ${p.hora}` : ""}
    </b>
    `;

    if(p.tipo === "mesa"){

      bloque += `
      <div style="display:flex;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap">

        ‚è± Tiempo: 
        <span id="timer_${i}" style="font-weight:bold;color:#c40000">
        ${p.atendido ? p.tiempoFinal : "00:00"}
        </span>

        ${!p.atendido ? `
        <button onclick="marcarAtendido(${i})" 
          style="background:green;color:white">
          ‚úÖ ATENDIDO
        </button>
        ` : `
        <button onclick="toggleColapsado(${i})"
          style="background:#6c757d;color:white">
          ${p.colapsado ? "üîΩ Ver" : "üîº Ocultar"}
        </button>
        `}

        <button onclick="eliminar(${i})"
          style="background:black;color:white">
          üóëÔ∏è
        </button>

      </div>
      <br>
      `;

    } else {

      bloque += `
      <button onclick="eliminar(${i})" style="float:right">üóëÔ∏è</button>
      <br><br>
      `;
    }

    if(!p.colapsado){

      if(p.detalleEntradas.length)
        bloque+=`<b>Entradas:</b><br>${
          p.detalleEntradas
          .map(x=>x.replace("NOTA:",
            "<span style='color:#c40000;font-weight:bold'>NOTA:</span>"
          ))
          .join("<br>")
        }<br><br>`;

      if(p.detalleSegundos.length)
        bloque+=`<b>Segundos:</b><br>${
          p.detalleSegundos
          .map(x=>x.replace("NOTA:",
            "<span style='color:#c40000;font-weight:bold'>NOTA:</span>"
          ))
          .join("<br>")
        }<br><br>`;

      if(p.detalleExtras.length)
        bloque+=`<b>Extras:</b><br>${p.detalleExtras.join("<br>")}<br><br>`;

      if(p.detalleEnvases.length)
        bloque+=`<b>Envases:</b><br>${p.detalleEnvases.join("<br>")}<br><br>`;

      bloque+=`<b>Total: S/ ${p.total.toFixed(2)}</b>`;
    }

    bloque+=`</div>`;

    if(p.tipo==="mesa") htmlMesa+=bloque;
    if(p.tipo==="reserva") htmlReserva+=bloque;
    if(p.tipo==="llevar") htmlLlevar+=bloque;

  });

  document.getElementById("seccion_mesa").innerHTML=htmlMesa;
  document.getElementById("seccion_reserva").innerHTML=htmlReserva;
  document.getElementById("seccion_llevar").innerHTML=htmlLlevar;
}




function eliminar(index){
  if(confirm("¬øEliminar este pedido?")){
    pedidos.splice(index,1);
    guardarHistorial();
    mostrar();
  }
}

function guardarHistorial(){
  db.collection("pedidos").doc("diaActual").set({
    lista: pedidos
  });
}

function reset(){

  document.querySelectorAll(".qty").forEach(e=>e.value=0);

  /* SOLO entradas */
  document.querySelectorAll("[id^='nota_E']").forEach(e=>e.value="");

  /* SOLO segundos */
  document.querySelectorAll("[id^='nota_S']").forEach(e=>e.value="");

  deliveryCosto.value=0;
  mesa.value="";
  calcularPreview();

}

function resetearDisponibles(){

  if(!confirm("¬øResetear todos los DISPONIBLES a cero?")) return;

  // reset entradas
  for(let i=0;i<TOTAL_ENTRADAS;i++){
    localStorage.setItem("E"+i+"-vendido", 0);
    actualizarDisponible("E"+i);
  }

  // reset segundos
  for(let i=0;i<TOTAL_SEGUNDOS;i++){
    localStorage.setItem("S"+i+"-vendido", 0);
    actualizarDisponible("S"+i);
  }

  alert("Disponibles reiniciados correctamente");
}



function calcularTiempoFinal(inicio){

  const ahora = Date.now();
  const diff = ahora - inicio;

  const minutos = Math.floor(diff / 60000);
  const segundos = Math.floor((diff % 60000) / 1000);

  return `${minutos.toString().padStart(2,"0")}:${segundos.toString().padStart(2,"0")}`;
}

function marcarAtendido(index){

  const ahora = Date.now();
  const inicio = pedidos[index].horaRegistro;

  const diff = ahora - inicio;

  const minutos = Math.floor(diff / 60000);
  const segundos = Math.floor((diff % 60000) / 1000);

  pedidos[index].tiempoFinal =
    `${minutos.toString().padStart(2,"0")}:`+
    `${segundos.toString().padStart(2,"0")}`;

  pedidos[index].atendido = true;
  pedidos[index].colapsado = true;

  // mover al final
  const pedidoFinalizado = pedidos.splice(index,1)[0];
  pedidos.push(pedidoFinalizado);

  guardarHistorial();
  mostrar();
}





function toggleColapsado(index){
  pedidos[index].colapsado = !pedidos[index].colapsado;
  guardarHistorial();
  mostrar();
}



/* =================================================
   INIT
================================================= */
crearMenuEditable(TOTAL_ENTRADAS,"entradas","E");
crearMenuEditable(TOTAL_SEGUNDOS,"segundos","S");
// üî• aplicar estado guardado
["entradas","segundos"].forEach(seccion=>{
  const oculto = localStorage.getItem("iniOculto_"+seccion);
  if(oculto === "1"){
    toggleIni(seccion);
  }
});


crearItems(extrasComida,"extrasComida");
crearItems(envases,"envases");

mostrar();
actualizarBotonesTipo();


// üî• TEMPORIZADOR GLOBAL (actualiza cada segundo)
setInterval(()=>{

  pedidos.forEach((p,i)=>{

    if(p.tipo === "mesa" && p.horaRegistro && !p.atendido){


      const span = document.getElementById("timer_"+i);
      const pedidoBox = document.getElementById("pedido_"+i);

      if(!span || !pedidoBox) return;

      const ahora = Date.now();
      const diff = ahora - p.horaRegistro;

      const minutos = Math.floor(diff / 60000);
      const segundos = Math.floor((diff % 60000) / 1000);

      span.innerText =
        `${minutos.toString().padStart(2,"0")}:`+
        `${segundos.toString().padStart(2,"0")}`;

      // üé® CAMBIO VISUAL DEL BLOQUE COMPLETO
      if(p.atendido){
        pedidoBox.style.background = "#f8f9fa";
        pedidoBox.style.borderLeft = "6px solid gray";
        return;
      }

      if(minutos < 5){
        pedidoBox.style.background = "#e9f7ef";
        pedidoBox.style.borderLeft = "6px solid #28a745";
      }
      else if(minutos < 10){
        pedidoBox.style.background = "#fff8e1";
        pedidoBox.style.borderLeft = "6px solid #ff9800";
      }
      else{
        pedidoBox.style.background = "#fdecea";
        pedidoBox.style.borderLeft = "6px solid #dc3545";
      }

    }

  });

},1000);



// üî• restaurar tipo guardado
const tipoGuardado = localStorage.getItem("tipoSeleccionado");
if(tipoGuardado){
  document.getElementById("tipo").value = tipoGuardado;
}

guardarTipo();
actualizarBotonesTipo();

for(let i=0;i<TOTAL_ENTRADAS;i++){
  actualizarDisponible("E"+i);
}
for(let i=0;i<TOTAL_SEGUNDOS;i++){
  actualizarDisponible("S"+i);
}

deliveryCosto.addEventListener("input",calcularPreview);

async function descargarWordTipo(tipoFiltrado){

  const pedidosFiltrados = pedidos.filter(p=>p.tipo===tipoFiltrado);

  if(pedidosFiltrados.length===0){
    alert("No hay pedidos en esta secci√≥n");
    return;
  }

  const {
    Document,
    Packer,
    Paragraph,
    TextRun,
    Table,
    TableRow,
    TableCell,
    WidthType,
    BorderStyle
  } = docx;

  const COLUMNAS = 6;

  let columnasPedidos = Array.from({length:COLUMNAS},()=>[]);

  pedidosFiltrados.forEach((p,i)=>{
    columnasPedidos[i % COLUMNAS].push(p);
  });

  const filas = [];
  const maxFilas = Math.max(...columnasPedidos.map(c=>c.length));

  for(let f=0; f<maxFilas; f++){

    const rowCells = [];

    for(let c=0; c<COLUMNAS; c++){

      const pedido = columnasPedidos[c][f];

      if(pedido){

        const contenido = [];

        contenido.push(
          new Paragraph({
            children:[
              new TextRun({
                text:(pedido.mesa||"SIN NOMBRE").toUpperCase(),
                bold:true,
                size:30
              })
            ],
            spacing:{ after:100 }
          })
        );

        pedido.detalleEntradas.forEach(l=>{
          contenido.push(
            new Paragraph({
              children:[ new TextRun({ text:l, size:24 }) ]
            })
          );
        });

        pedido.detalleSegundos.forEach(l=>{
          contenido.push(
            new Paragraph({
              children:[ new TextRun({ text:l, size:24 }) ]
            })
          );
        });

        rowCells.push(
          new TableCell({
            width:{ size:100/COLUMNAS, type:WidthType.PERCENTAGE },
            margins:{ top:100, bottom:100, left:150, right:150 },
            borders:{
              left:{style:BorderStyle.SINGLE, size:4, color:"cccccc"},
              right:{style:BorderStyle.SINGLE, size:4, color:"cccccc"},
              top:{style:BorderStyle.NONE},
              bottom:{style:BorderStyle.NONE}
            },
            children:contenido
          })
        );

      } else {

        rowCells.push(
          new TableCell({
            width:{ size:100/COLUMNAS, type:WidthType.PERCENTAGE },
            children:[new Paragraph("")]
          })
        );

      }

    }

    filas.push(new TableRow({ children: rowCells }));

  }

  const tabla = new Table({
    width:{ size:100, type:WidthType.PERCENTAGE },
    rows: filas
  });

  const doc = new Document({
    sections:[{
      properties:{
        page:{
          size:{ orientation:"landscape" },
          margin:{ top:250, right:250, bottom:250, left:250 }
        }
      },
      children:[tabla]
    }]
  });

  const blob = await Packer.toBlob(doc);

  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="Pedidos-"+tipoFiltrado+"-ElMisti.docx";
  link.click();
}




</script>




</body>
</html>
