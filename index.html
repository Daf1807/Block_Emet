<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Registro Pedidos - El Misti</title>

<style>
:root{
  --rojo:#9e1c1c;
  --amarillo:#f5b400;
  --bg:#f2f2f2;
}

body{
  font-family:system-ui, Arial;
  margin:0;
  background:var(--bg);
}

/* HEADER */
header{
  background:var(--rojo);
  color:white;
  padding:14px;
  text-align:center;
  font-size:20px;
  font-weight:bold;
}

/* SECCIONES */
section{ padding:12px }

.card{
  background:white;
  border-radius:12px;
  padding:10px;
  margin-bottom:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}

h2{
  color:var(--rojo);
  margin:8px 0;
}

/* PLATOS */
.item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 0;
  border-bottom:1px solid #eee;
}

.controls{
  display:flex;
  gap:8px;
  align-items:center;
}

.qty{
  width:35px;
  text-align:center;
  font-weight:bold;
  border:none;
  font-size:16px;
}

/* BOTONES */
button{
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
}

.btn{
  background:var(--rojo);
  color:white;
}

.big{
  width:100%;
  padding:14px;
  background:var(--amarillo);
  font-weight:bold;
  font-size:18px;
}

/* PEDIDOS */
.pedido{
  background:white;
  border-left:6px solid var(--rojo);
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
}

/* GRID PC */
@media(min-width:700px){
  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
}
</style>
</head>

<body>

<header>üçΩÔ∏è EL MISTI - Registro de Pedidos</header>

<section>

<div class="card">
Tipo:
<select id="tipo">
  <option value="mesa">Mesa</option>
  <option value="llevar">Llevar</option>
  <option value="delivery">Delivery</option>
  <option value="reserva">Reserva</option>
</select>
<br><br>
Mesa / Nombre:
<input id="mesa" style="width:100%">
</div>

<div class="grid">

<div class="card">
<h2>Entradas</h2>
<div id="entradas"></div>
</div>

<div class="card">
<h2>Segundos</h2>
<div id="segundos"></div>
</div>

</div>

<!-- EXTRAS COMIDA -->
<div class="card">
<h2>üç≥ Extras comida</h2>
<div id="extrasComida"></div>
</div>

<!-- ENVASES -->
<div class="card">
<h2>ü•° Envases para llevar</h2>
<div id="envases"></div>
</div>

<!-- DELIVERY -->
<div class="card">
<h2>üöö Delivery</h2>
Costo adicional:
<input type="number" id="deliveryCosto" value="0" min="0" step="0.5" style="width:80px"> soles
</div>

<button class="big" onclick="registrarPedido()">‚úÖ Registrar pedido</button>

<button class="big" onclick="descargarWord()">
üìÑ Descargar pedidos (Word)
</button>


<h2>üìã Pedidos del d√≠a</h2>
<div id="listaPedidos"></div>

</section>

<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>


<script>
/* =================================================
   CANTIDADES FIJAS (LO √öNICO NUEVO)
================================================= */
const TOTAL_ENTRADAS = 5;
const TOTAL_SEGUNDOS = 10;


/* =================================================
   EXTRAS Y ENVASES (INTOCABLES ‚Äì IGUAL QUE TUYO)
================================================= */
const extrasComida=[
 {nombre:"Arroz extra",precio:2},
 {nombre:"Presa adicional",precio:5},
 {nombre:"Vaso adicional",precio:1},
 {nombre:"Medio vaso refresco",precio:0.5}
];

const envases=[
 {nombre:"Taper grande",precio:1},
 {nombre:"Taper chico",precio:0.5}
];

let pedidos = JSON.parse(localStorage.getItem("pedidosMisti")) || [];


/* =================================================
   NUEVO: CREAR ENTRADAS/SEGUNDOS EDITABLES
   (MISMO DISE√ëO .item .controls .qty)
================================================= */
function crearMenuEditable(total, cont, prefijo){

  const div=document.getElementById(cont);

  for(let i=0;i<total;i++){

    const key=prefijo+i;
    const nombreGuardado =
      localStorage.getItem(key+"-nombre") || "";

    div.innerHTML+=`
      <div class="item" style="flex-direction:column;align-items:stretch">

        <!-- fila nombre + cantidad -->
        <div style="display:flex;align-items:center;gap:8px">

          <input
            value="${nombreGuardado}"
            placeholder="Nombre..."
            oninput="localStorage.setItem('${key}-nombre',this.value)"
            style="flex:1">

          <div class="controls">
            <button onclick="cambiar('${key}',-1)">-</button>
            <input class="qty" id="${key}" value="0" readonly>
            <button onclick="cambiar('${key}',1)">+</button>

            <!-- üî• BOT√ìN NOTA -->
            <button 
              type="button"
              onclick="toggleNota('${key}')"
              style="
                background:#eee;
                padding:6px 8px;
                border-radius:6px;
                font-size:12px;
              ">
              üìù
            </button>
          </div>

        </div>

        <!-- üî• NOTA OCULTA -->
        <input
          id="nota_${key}"
          placeholder="Nota (sin arroz, sin papa, etc)"
          style="
            display:none;
            margin-top:5px;
            font-size:12px;
            padding:4px;
            border:1px solid #ddd;
            border-radius:6px;
            width:100%;
          ">

      </div>`;
  }
}





/* =================================================
   CREAR ITEMS (AHORA CON NOTA POR PLATO)
================================================= */
function crearItems(lista, cont){
  const div=document.getElementById(cont);

  lista.forEach(i=>{
    const nombre=i.nombre||i;

    div.innerHTML+=`
      <div class="item">
        ${nombre} ${i.precio?`(S/ ${i.precio})`:""}
        <div class="controls">
          <button onclick="cambiar('${nombre}',-1)">-</button>
          <input class="qty" id="${nombre}" value="0" readonly>
          <button onclick="cambiar('${nombre}',1)">+</button>
        </div>
      </div>`;
  });
}




/* =================================================
   + / -  (TUYO)
================================================= */
function cambiar(id,n){
  const el=document.getElementById(id);
  let v=parseInt(el.value)+n;
  if(v<0)v=0;
  el.value=v;
}

function toggleNota(id){

  const campo = document.getElementById("nota_"+id);

  if(campo.style.display === "none"){
    campo.style.display = "block";
    campo.focus();
  }else{
    campo.style.display = "none";
  }

}


/* =================================================
   REGISTRAR (MISMA L√ìGICA + solo cambio de lectura)
================================================= */
function registrarPedido(){

  let total=0;
  let ent=0, seg=0;

  let detalleEntradas=[];
  let detalleSegundos=[];
  let detalleExtras=[];
  let detalleEnvases=[];

  /* ENTRADAS */
  for(let i=0;i<TOTAL_ENTRADAS;i++){
    const nombre=localStorage.getItem("E"+i+"-nombre");
    const c=+document.getElementById("E"+i).value;

    if(nombre && c>0){

  const nota=document.getElementById("nota_E"+i)?.value || "";

  let texto=`${c} - ${nombre}`;
  if(nota) texto+=` | NOTA: ${nota.toUpperCase()}`;

  detalleEntradas.push(texto);
  ent+=c;
}

  }

  /* SEGUNDOS */
  for(let i=0;i<TOTAL_SEGUNDOS;i++){
    const nombre=localStorage.getItem("S"+i+"-nombre");
    const c=+document.getElementById("S"+i).value;

    if(nombre && c>0){

  const nota=document.getElementById("nota_S"+i)?.value || "";

  let texto=`${c} - ${nombre}`;
  if(nota) texto+=` | NOTA: ${nota.toUpperCase()}`;

  detalleSegundos.push(texto);
  seg+=c;
}

  }

  const menus=Math.min(ent,seg);

  total+=menus*13;
  total+=(seg-menus)*10;
  total+=(ent-menus)*5;

  /* EXTRAS (IGUAL) */
  extrasComida.forEach(e=>{
    const c=+document.getElementById(e.nombre).value;
    if(c>0){
      detalleExtras.push(`${c} - ${e.nombre}`);
      total+=c*e.precio;
    }
  });

  /* ENVASES (IGUAL) */
  envases.forEach(e=>{
    const c=+document.getElementById(e.nombre).value;
    if(c>0){
      detalleEnvases.push(`${c} - ${e.nombre}`);
      total+=c*e.precio;
    }
  });

  const delivery=+deliveryCosto.value;
  total+=delivery;

  pedidos.push({
    tipo:tipo.value,
    mesa:mesa.value,
    detalleEntradas,
    detalleSegundos,
    detalleExtras,
    detalleEnvases,
    delivery,
    total
  });

  guardarHistorial();
  mostrar();
  reset();
}


/* =================================================
   TODO LO DEM√ÅS IGUAL (MOSTRAR / ELIMINAR / ETC)
================================================= */
function mostrar(){

  let html="";

  pedidos.forEach((p,i)=>{

    html+=`
    <div class="pedido">

      <b>#${i+1} | ${p.tipo.toUpperCase()} | ${p.mesa||"-"}</b>
      <button onclick="eliminar(${i})" style="float:right">üóëÔ∏è</button>
      <br><br>
    `;

   if(p.detalleEntradas.length)
  html+=`<b>Entradas:</b><br>${
    p.detalleEntradas
      .map(x=>x.replace("NOTA:",
        "<span style='color:#c40000;font-weight:bold'>NOTA:</span>"
      ))
      .join("<br>")
  }<br><br>`;

if(p.detalleSegundos.length)
  html+=`<b>Segundos:</b><br>${
    p.detalleSegundos
      .map(x=>x.replace("NOTA:",
        "<span style='color:#c40000;font-weight:bold'>NOTA:</span>"
      ))
      .join("<br>")
  }<br><br>`;


    if(p.detalleExtras.length)
      html+=`<b>Extras:</b><br>${p.detalleExtras.join("<br>")}<br><br>`;

    if(p.detalleEnvases.length)
      html+=`<b>Envases:</b><br>${p.detalleEnvases.join("<br>")}<br><br>`;

    if(p.delivery>0)
      html+=`<b>Delivery:</b> S/ ${p.delivery}<br><br>`;

    html+=`<b>Total: S/ ${p.total.toFixed(2)}</b></div>`;
  });

  listaPedidos.innerHTML=html;
}

function eliminar(index){
  if(confirm("¬øEliminar este pedido?")){
    pedidos.splice(index,1);
    guardarHistorial();
    mostrar();
  }
}

function guardarHistorial(){
  localStorage.setItem("pedidosMisti", JSON.stringify(pedidos));
}

function reset(){

  document.querySelectorAll(".qty").forEach(e=>e.value=0);

  /* SOLO entradas */
  document.querySelectorAll("[id^='nota_E']").forEach(e=>e.value="");

  /* SOLO segundos */
  document.querySelectorAll("[id^='nota_S']").forEach(e=>e.value="");

  deliveryCosto.value=0;
  mesa.value="";
}




/* =================================================
   INIT
================================================= */
crearMenuEditable(TOTAL_ENTRADAS,"entradas","E");
crearMenuEditable(TOTAL_SEGUNDOS,"segundos","S");

crearItems(extrasComida,"extrasComida");
crearItems(envases,"envases");

mostrar();

async function descargarWord(){

  if(pedidos.length===0){
    alert("No hay pedidos");
    return;
  }

  const {
    Document,
    Packer,
    Paragraph,
    TextRun,
    Table,
    TableRow,
    TableCell,
    WidthType,
    BorderStyle
  } = docx;

  const COLUMNAS = 6;

  // üî• Repartir pedidos verticalmente
  let columnasPedidos = Array.from({length:COLUMNAS},()=>[]);

  pedidos.forEach((p,i)=>{
    columnasPedidos[i % COLUMNAS].push(p);
  });

  // üî• Convertimos cada columna en un bloque vertical
  const filas = [];
  const maxFilas = Math.max(...columnasPedidos.map(c=>c.length));

  for(let f=0; f<maxFilas; f++){

    const rowCells = [];

    for(let c=0; c<COLUMNAS; c++){

      const pedido = columnasPedidos[c][f];

      if(pedido){

        const contenido = [];

        contenido.push(
          new Paragraph({
            children:[
              new TextRun({
                text:(pedido.mesa||"SIN NOMBRE").toUpperCase(),
                bold:true,
                size:30
              })
            ],
            spacing:{ after:100 }
          })
        );

        pedido.detalleEntradas.forEach(l=>{
          contenido.push(
            new Paragraph({
              children:[ new TextRun({ text:l, size:24 }) ]
            })
          );
        });

        pedido.detalleSegundos.forEach(l=>{
          contenido.push(
            new Paragraph({
              children:[ new TextRun({ text:l, size:24 }) ]
            })
          );
        });

        rowCells.push(
          new TableCell({
            width:{ size:100/COLUMNAS, type:WidthType.PERCENTAGE },
            margins:{ top:100, bottom:100, left:150, right:150 },
            borders:{
              left:{style:BorderStyle.SINGLE, size:4, color:"cccccc"},
              right:{style:BorderStyle.SINGLE, size:4, color:"cccccc"},
              top:{style:BorderStyle.NONE},
              bottom:{style:BorderStyle.NONE}
            },
            children:contenido
          })
        );

      } else {
        rowCells.push(
          new TableCell({
            width:{ size:100/COLUMNAS, type:WidthType.PERCENTAGE },
            children:[new Paragraph("")]
          })
        );
      }

    }

    filas.push(new TableRow({ children: rowCells }));

  }

  const tabla = new Table({
    width:{ size:100, type:WidthType.PERCENTAGE },
    rows: filas
  });

  const doc = new Document({
    sections:[{
      properties:{
        page:{
          size:{ orientation:"landscape" },
          margin:{ top:250, right:250, bottom:250, left:250 }
        }
      },
      children:[tabla]
    }]
  });

  const blob = await Packer.toBlob(doc);

  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="Pedidos-ElMisti.docx";
  link.click();
}





</script>




</body>
</html>
