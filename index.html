<!DOCTYPE html>
<html lang="es">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Registro Pedidos - El Misti</title>

<style>
:root{
  --rojo:#8B0000;
  --amarillo:#FFC107;
  --bg:#f4f6f9;
  --card:#ffffff;
  --gris-suave:#f8f9fa;
}


body{
  font-family: 'Poppins', sans-serif;
  margin:0;
  background: linear-gradient(135deg,#f4f6f9,#e9edf3);
}


/* HEADER */
header{
  background:var(--rojo);
  color:white;
  padding:14px;
  text-align:center;
  font-size:20px;
  font-weight:bold;
}

/* SECCIONES */
section{ padding:12px }

.card{
  background:var(--card);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  transition:transform .2s ease, box-shadow .2s ease;
}

.card:hover{
  transform:translateY(-3px);
  box-shadow:0 12px 25px rgba(0,0,0,.12);
}


h2{
  color:var(--rojo);
  margin:8px 0;
}

/* PLATOS */
.item{
  display:flex;
  flex-wrap:wrap; /* üî• permite bajar l√≠nea */
  align-items:center;
  gap:8px;
  padding:8px 0;
  border-bottom:1px solid #eee;
}

.controls{
  display:flex;
  gap:8px;
  align-items:center;
}

.qty{
  width:35px;
  text-align:center;
  font-weight:bold;
  border:none;
  font-size:16px;
}

/* BOTONES */
button{
  border:none;
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  transition:all .2s ease;
}

button:hover{
  transform:scale(1.05);
  opacity:.9;
}

.btn{
  background:var(--rojo);
  color:white;
}

.big{
  width:100%;
  padding:14px;
  background:var(--amarillo);
  font-weight:bold;
  font-size:18px;
}

/* PEDIDOS */
.pedido{
  background:white;
  border-left:6px solid var(--rojo);
  padding:14px;
  margin-bottom:14px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.06);
  transition:all .2s ease;
}

.pedido:hover{
  transform:scale(1.01);
}


/* GRID PC */
@media(min-width:700px){
  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
}

.timer-box{
  display:inline-block;
  padding:6px 12px;
  border-radius:8px;
  font-weight:bold;
  font-size:16px;
  transition:all .3s ease;
}

.timer-green{
  background:#d4edda;
  color:#155724;
}

.timer-orange{
  background:#fff3cd;
  color:#856404;
}

.timer-red{
  background:#f8d7da;
  color:#721c24;
  animation:parpadeo 1s infinite;
}

@keyframes parpadeo{
  0%{opacity:1}
  50%{opacity:.5}
  100%{opacity:1}
}

.progress-bar{
  height:6px;
  background:#eee;
  border-radius:4px;
  margin-top:6px;
  overflow:hidden;
}

.progress-fill{
  height:100%;
  width:0%;
  background:#28a745;
  transition:width .5s linear;
}

.colIni{
  width:75px;
  padding:8px;
  border-radius:10px;
  border:2px solid #e0e0e0;
  font-weight:600;
  text-align:center;
  background:#f8f9fa;
  font-size:15px;
  transition:all .25s ease;
  outline:none;
}

/* Hover */
.colIni:hover{
  border-color:#bdbdbd;
  transform:scale(1.05);
}

/* Cuando est√° activo */
.colIni:focus{
  border-color:#4CAF50;
  box-shadow:0 0 0 3px rgba(76,175,80,.2);
  background:white;
  transform:scale(1.07);
}

/* Cuando tiene n√∫mero diferente de 0 */
.colIni:not([value="0"]){
  border-color:#4CAF50;
  background:#f1fff4;
}

  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button{
    opacity:1;
  }

.nombrePlato{
  flex:1;
  padding:10px 12px;
  font-size:17px;
  font-weight:600;
  border-radius:12px;
  border:2px solid #e0e0e0;
  background:#ffffff;
  transition:all .25s ease;
  outline:none;
}

/* Hover */
.nombrePlato:hover{
  border-color:#bdbdbd;
}

/* Cuando escribes */
.nombrePlato:focus{
  border-color:#2196F3;
  box-shadow:0 0 0 3px rgba(33,150,243,.2);
  background:#fff;
}

.filaMenu{
  display:flex;
  gap:10px;
  align-items:center;
}

#tipo{
  display:none;
}

.tipoSelector{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.tipoSelector button{
  flex:1;
  padding:10px;
  font-size:16px;
  font-weight:600;
  border-radius:12px;
  border:2px solid #e0e0e0;
  background:#ffffff;
  cursor:pointer;
  transition:all .25s ease;
}

.tipoSelector button:hover{
  border-color:#bdbdbd;
  transform:scale(1.03);
}

.tipoSelector button.activo{
  background:#4CAF50;
  color:white;
  border-color:#4CAF50;
  box-shadow:0 0 0 3px rgba(76,175,80,.2);
}

@media(max-width:600px){

  .nombrePlato{
    width:100%;
  }

  .controls{
    width:100%;
    justify-content:flex-end;
  }

}

.cuadro-servir{
  display:inline-block;
  width:18px;
  height:18px;
  border:2px solid #8B0000;
  margin-left:4px;
  border-radius:4px;
  cursor:pointer;
}

.cuadro-servir.servido{
  background:#8B0000;
}

.login-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  background: linear-gradient(135deg, #7b2ff7, #f107a3);
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: 'Segoe UI', sans-serif;
}

.login-box {
  background: white;
  padding: 40px;
  border-radius: 15px;
  width: 320px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  animation: fadeIn 0.6s ease-in-out;
}

.login-box h2 {
  margin-bottom: 5px;
  color: #7b2ff7;
}

.subtitulo {
  font-size: 14px;
  color: #777;
  margin-bottom: 20px;
}

.login-box input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-bottom: 15px;
  font-size: 14px;
}

.login-box input:focus {
  outline: none;
  border-color: #7b2ff7;
}

.login-box button {
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 8px;
  background: #7b2ff7;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}

.login-box button:hover {
  background: #5f22c5;
}

#mensajeError {
  margin-top: 10px;
  color: red;
  font-size: 13px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

</style>
</head>

<body>

<div id="loginPantalla" class="login-container">
  <div class="login-box">
    <h2>üîê EL MISTI</h2>
    <p class="subtitulo">Sistema de Gesti√≥n</p>

    <input type="password" id="inputClave" placeholder="Ingrese contrase√±a">
    <button onclick="verificarClave()">Ingresar</button>

    <p id="mensajeError"></p>
  </div>
</div>

<div id="sistema" style="display:none;">


<header>üçΩÔ∏è EL MISTI - Registro de Pedidos</header>

<div style="display:flex;gap:10px;padding:10px;justify-content:center">

  <button onclick="cambiarVista('meseros')">üë®‚Äçüíº Meseros</button>
  <button onclick="cambiarVista('cocina')">üë®‚Äçüç≥ Cocina</button>
  <button onclick="cambiarVista('clientes')">üëÄ Pantalla Clientes</button>

</div>


<div id="vista_meseros">



          <section>

          <div class="card">
          Tipo:
          <select id="tipo" onchange="guardarTipo()">
            <option value="mesa">Mesa</option>
            <option value="llevar">Llevar</option>
            <option value="reserva">Reserva</option>
          </select>

          <div class="tipoSelector">
            <button type="button" onclick="cambiarTipo('mesa')" id="btnMesa">Mesa</button>
            <button type="button" onclick="cambiarTipo('llevar')" id="btnLlevar">Llevar</button>
            <button type="button" onclick="cambiarTipo('reserva')" id="btnReserva">Reserva</button>
          </div>


          Mesa / Nombre:
          <input id="mesa" style="width:100%">
          <div id="mesasBotones" style="margin-top:10px;display:none;"></div>

          </div>

          <div class="grid">

          <div class="card">
          <h2>Entradas</h2>

          <div style="display:flex;align-items:center;gap:6px;font-weight:bold;margin-bottom:6px">

            <button onclick="toggleIni('entradas')" 
                    style="padding:2px 6px;border-radius:6px">
              üëÅ
            </button>

            <div class="colIni" style="width:60px">Ini</div>
            <div style="width:80px">Disp</div>
            <div style="flex:1">Entradas</div>

          </div>


          <div id="entradas"></div>
          </div>


          <div class="card">
          <h2>Segundos</h2>

          <div style="display:flex;align-items:center;gap:6px;font-weight:bold;margin-bottom:6px">

            <button onclick="toggleIni('segundos')" 
                    style="padding:2px 6px;border-radius:6px">
              üëÅ
            </button>

            <div class="colIni" style="width:60px">Ini</div>
            <div style="width:80px">Disp</div>
            <div style="flex:1">Segundos</div>

          </div>


          <div id="segundos"></div>
          </div>

          </div>

          <!-- EXTRAS COMIDA -->
          <div class="card">
          <h2>üç≥ Extras comida</h2>
          <div id="extrasComida"></div>
          </div>

          <!-- ENVASES -->
          <div class="card">
          <h2>ü•° Envases para llevar</h2>
          <div id="envases"></div>
          </div>

          <!-- DELIVERY -->
          <div class="card">
          <h2>üöö Delivery</h2>
          Costo adicional:
          <input type="number" id="deliveryCosto" value="0" min="0" step="0.5" style="width:80px"> soles
          </div>

          <div class="card" style="text-align:center;font-size:22px;font-weight:700;color:#2c3e50">
            üí∞ Total actual: <b id="totalPreview">S/ 0.00</b>
          </div>


          <button class="big" onclick="registrarPedido()">‚úÖ Registrar pedido</button>

          <button class="btn" onclick="resetearDisponibles()" style="margin-top:10px;width:100%">
          üîÑ Resetear DISP
          </button>

          <button class="btn" onclick="eliminarTodo()" 
          style="margin-top:10px;width:100%;background:black">
          üóëÔ∏è Eliminar TODOS los pedidos
          </button>



          <h2>üìã Pedidos del d√≠a</h2>

          <div style="display:flex;gap:10px;margin-bottom:15px">
            <button onclick="mostrarSeccionPedidos('mesa')" id="btnMesaPedidos">üçΩ Mesa</button>
            <button onclick="mostrarSeccionPedidos('reserva')" id="btnReservaPedidos">üìÖ Reserva</button>
            <button onclick="mostrarSeccionPedidos('llevar')" id="btnLlevarPedidos">ü•° Llevar</button>
          </div>
          
            <div style="display:none">
              <div id="seccion_mesa"></div>
              <div id="seccion_reserva"></div>
              <div id="seccion_llevar"></div>
            </div>

              <div id="contenedorPedidos" class="card"></div>


          </section>

          <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>

          <!-- Firebase -->
          <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
          <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>


          <script>

const CLAVE_PRINCIPAL = "MISTI2026";

function verificarClave() {

  const clave = document.getElementById("inputClave").value;

  if (clave === CLAVE_PRINCIPAL) {

    const ahora = new Date();
    const expiracion = new Date();

    expiracion.setHours(17, 0, 0, 0); // 5:00 PM

    if (ahora > expiracion) {
      alert("Ya pas√≥ la hora l√≠mite de acceso.");
      return;
    }

    localStorage.setItem("sesionActiva", "true");
    localStorage.setItem("expiraEn", expiracion.getTime());

    mostrarSistema();

  } else {
    document.getElementById("mensajeError").innerText = "Contrase√±a incorrecta";
  }
}

            // üî• CONFIG FIREBASE
          const firebaseConfig = {
            apiKey: "AIzaSyCakBN0YRTOGCKVQ7A5iLKksNh0cjF-JOg",
            authDomain: "el-misti-pedidos.firebaseapp.com",
            projectId: "el-misti-pedidos",
            storageBucket: "el-misti-pedidos.firebasestorage.app",
            messagingSenderId: "337950171428",
            appId: "1:337950171428:web:7a8124d45ec9e44fbe13b1",
            measurementId: "G-3VSKDP2KF9"
          };

          // Inicializar Firebase
          firebase.initializeApp(firebaseConfig);
          const db = firebase.firestore();


function mostrarSistema() {
  document.getElementById("loginPantalla").style.display = "none";
  document.getElementById("sistema").style.display = "block";

  // üî• recuperar √∫ltima vista guardada
  const vistaGuardada = localStorage.getItem("vistaActualMisti");

  if (vistaGuardada) {
    cambiarVista(vistaGuardada);
  } else {
    cambiarVista("meseros"); // por defecto meseros
  }
}


// Verificar sesi√≥n al cargar p√°gina
window.onload = function() {
  const sesion = localStorage.getItem("sesionActiva");
  const expiraEn = localStorage.getItem("expiraEn");

  if (sesion === "true" && expiraEn) {
    const ahora = new Date().getTime();

    if (ahora < parseInt(expiraEn)) {
      mostrarSistema();
    } else {
      localStorage.removeItem("sesionActiva");
      localStorage.removeItem("expiraEn");
    }
  }
};


          /* =================================================
            üî• STOCK EN TIEMPO REAL DESDE FIRESTORE
          ================================================= */

function cambiarVista(vista){

  vistaActual = vista;
  localStorage.setItem("vistaActualMisti", vista);

  document.getElementById("vista_meseros").style.display = "none";
  document.getElementById("vista_cocina").style.display = "none";
  document.getElementById("vista_clientes").style.display = "none";

  if(vista==="meseros")
    document.getElementById("vista_meseros").style.display = "block";

  if(vista==="cocina")
    document.getElementById("vista_cocina").style.display = "block";

  if(vista==="clientes")
    document.getElementById("vista_clientes").style.display = "block";

  mostrar();
}




function mostrarCocina(){

  const pedidosMesa = pedidos.filter(p=>p.tipo==="mesa" && !p.atendido);

  let acumuladoEntradas = {};
  let acumuladoSegundos = {};

  pedidosMesa.forEach(p=>{

      p.detalleEntradas.forEach(item=>{
        const partes = item.split(" - ");
        const cantidad = parseInt(partes[0]) || 0;
        const nombre = partes[1]?.split("|")[0].trim();

        if(nombre){

          const servidos =
            p.servidos?.entrada?.[nombre]
              ? p.servidos.entrada[nombre].length
              : 0;

          const pendiente = cantidad - servidos;

          if(pendiente > 0){
            acumuladoEntradas[nombre] =
              (acumuladoEntradas[nombre] || 0) + pendiente;
          }

        }
      });

      p.detalleSegundos.forEach(item=>{
        const partes = item.split(" - ");
        const cantidad = parseInt(partes[0]) || 0;
        const nombre = partes[1]?.split("|")[0].trim();

        if(nombre){

          const servidos =
            p.servidos?.segundo?.[nombre]
              ? p.servidos.segundo[nombre].length
              : 0;

          const pendiente = cantidad - servidos;

          if(pendiente > 0){
            acumuladoSegundos[nombre] =
              (acumuladoSegundos[nombre] || 0) + pendiente;
          }

        }
      });

  });

  let html = `
    <div style="
      background:#111;
      color:white;
      padding:20px;
      font-size:24px;
      font-weight:bold;
      border-bottom:4px solid #FFC107;
    ">
  `;

  html += `<div style="margin-bottom:15px">üç≤ ENTRADAS POR SERVIR:</div>`;

  for(let nombre in acumuladoEntradas){
    html += `
      <div style="display:flex;justify-content:space-between;font-size:22px">
        <div>${nombre}</div>
        <div>${acumuladoEntradas[nombre]}</div>
      </div>
    `;
  }

  html += `<br><div style="margin-bottom:15px">üçõ SEGUNDOS POR SERVIR:</div>`;

  for(let nombre in acumuladoSegundos){
    html += `
      <div style="display:flex;justify-content:space-between;font-size:22px">
        <div>${nombre}</div>
        <div>${acumuladoSegundos[nombre]}</div>
      </div>
    `;
  }

  html += `</div>`;

  pedidos.forEach((p,i)=>{

    if(p.tipo==="mesa" && !p.atendido){

      html+=`
        <div class="pedido" id="pedido_${i}">

          <div style="font-size:26px;font-weight:bold;margin-bottom:10px">
            üçΩÔ∏è MESA ${p.mesa}
          </div>

        
            ‚è± 
            <span class="timer"
                  data-hora="${p.horaRegistro || ''}"
                  data-atendido="${p.atendido ? '1' : '0'}"
                  style="font-weight:bold;color:#c40000">
              00:00
            </span>
          <br><br>

          ${p.detalleEntradas.length ? "<b>Entradas:</b><br>"+p.detalleEntradas.join("<br>")+"<br><br>" : ""}
          ${p.detalleSegundos.length ? "<b>Segundos:</b><br>"+p.detalleSegundos.join("<br>")+"<br><br>" : ""}

        </div>
      `;
    }

  });

  document.getElementById("cocina_contenido").innerHTML = html;
}

function dibujarItemsMesero(lista, indexPedido, tipo){

  let html = "";

  lista.forEach((item, indexItem) => {

    let partes = item.split(" - ");
    let cantidad = parseInt(partes[0]);
    let nombre = partes[1]?.split("|")[0].trim();

    html += `
      <div style="
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:8px;
      ">
        
        <div>
          <b>${cantidad} - ${nombre}</b>
        </div>

        <div>
    `;

    for(let i=0;i<cantidad;i++){

      const estaServido =
        pedidos[indexPedido].servidos?.[tipo]?.[nombre]?.includes(i);

      html += `
        <span 
          onclick="marcarEntregado(${indexPedido},'${tipo}',${indexItem},${i})"
          id="chk_${indexPedido}_${tipo}_${indexItem}_${i}"
          style="
            display:inline-block;
            width:18px;
            height:18px;
            border:2px solid #444;
            margin-left:4px;
            cursor:pointer;
            background:${estaServido ? "green" : "transparent"};
          ">
        </span>
      `;
    }

    html += `
        </div>
      </div>
    `;
  });

  return html;
}

function marcarEntregado(pedidoIndex, tipo, itemIndex, cuadritoIndex){

  let id = `chk_${pedidoIndex}_${tipo}_${itemIndex}_${cuadritoIndex}`;
  let cuadro = document.getElementById(id);

  if(!pedidos[pedidoIndex].servidos){
    pedidos[pedidoIndex].servidos = {
      entrada: {},
      segundo: {}
    };
  }

  const grupo = tipo; // "entrada" o "segundo"

  const itemTexto = grupo === "entrada"
    ? pedidos[pedidoIndex].detalleEntradas[itemIndex]
    : pedidos[pedidoIndex].detalleSegundos[itemIndex];

  const nombre = itemTexto.split(" - ")[1]?.split("|")[0].trim();

  if(!pedidos[pedidoIndex].servidos[grupo][nombre]){
    pedidos[pedidoIndex].servidos[grupo][nombre] = [];
  }

  if(cuadro.style.background === "green"){

    cuadro.style.background = "";

    pedidos[pedidoIndex].servidos[grupo][nombre] =
      pedidos[pedidoIndex].servidos[grupo][nombre]
      .filter(i => i !== cuadritoIndex);

  }else{

    cuadro.style.background = "green";

    pedidos[pedidoIndex].servidos[grupo][nombre]
      .push(cuadritoIndex);

  }

  guardarHistorial();
  mostrar();

  if(vistaActual === "cocina"){
    mostrarCocina();
  }

}



function dibujarItemsConCuadros(lista, indexPedido, tipo){

  if(!lista.length) return "";

  let agrupado = {};

  lista.forEach(item=>{
    agrupado[item] = (agrupado[item] || 0) + 1;
  });

  let html = "";

  Object.keys(agrupado).forEach(nombre=>{
    let cantidad = agrupado[nombre];

    html += `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">

        <div>
          ${cantidad} - ${nombre}
        </div>

        <div>
          ${Array(cantidad).fill(0).map((_,c)=>`
            <span class="cuadro-servir"
                  onclick="marcarServido(${indexPedido}, '${nombre}', '${tipo}')">
            </span>
          `).join("")}
        </div>

      </div>
    `;
  });

  return html + "<br>";
}


function mostrarClientes(){

  let html = `
    <div style="padding:20px">
      <h2 style="text-align:center">üç≤ ENTRADAS DISPONIBLES</h2>
  `;

  db.collection("stock")
    .doc("entradas")
    .collection("items")
    .get()
    .then(snapshot=>{

      snapshot.forEach(doc=>{

        const data = doc.data();
        const nombre = data.nombre || "";
        const inicial = data.inicial || 0;
        const vendido = data.vendido || 0;
        const disponible = inicial - vendido;

        if(nombre && disponible > 0){

          html += `
            <div style="
              display:flex;
              justify-content:space-between;
              padding:10px;
              font-size:26px;
              border-bottom:1px solid #ddd;
            ">
              <div>${nombre}</div>
              <div style="font-weight:bold;color:${disponible<=5?'red':'green'}">
                ${disponible}
              </div>
            </div>
          `;
        }

      });

      html += `<br><h2 style="text-align:center">üçõ SEGUNDOS DISPONIBLES</h2>`;

      return db.collection("stock")
        .doc("segundos")
        .collection("items")
        .get();

    })
    .then(snapshot=>{

      snapshot.forEach(doc=>{

        const data = doc.data();
        const nombre = data.nombre || "";
        const inicial = data.inicial || 0;
        const vendido = data.vendido || 0;
        const disponible = inicial - vendido;

        if(nombre && disponible > 0){

          html += `
            <div style="
              display:flex;
              justify-content:space-between;
              padding:10px;
              font-size:26px;
              border-bottom:1px solid #ddd;
            ">
              <div>${nombre}</div>
              <div style="font-weight:bold;color:${disponible<=5?'red':'green'}">
                ${disponible}
              </div>
            </div>
          `;
        }

      });

      html += `</div>`;

      document.getElementById("vista_clientes").innerHTML = html;

    });

}


function marcarServido(indexPedido, nombre, tipo){

  let pedido = pedidos[indexPedido];

  let lista = tipo==="entrada" 
    ? pedido.detalleEntradas 
    : pedido.detalleSegundos;

  let indexItem = lista.indexOf(nombre);

  if(indexItem !== -1){
    lista.splice(indexItem,1);
  }

  mostrar();
}




          function escucharStock(seccion, total, prefijo){

            for(let i=0;i<total;i++){

              const id = prefijo+i;

              const ref = db.collection("stock")
                .doc(seccion)
                .collection("items")
                .doc(id);

              // üî• crear documento si no existe
              ref.get().then(doc=>{
                if(!doc.exists){
                  ref.set({
                    inicial: 0,
                    vendido: 0,
                    nombre: ""
                  });
                }
              });

              // üî• escuchar individualmente
              ref.onSnapshot(doc=>{

                if(!doc.exists) return;

                const data = doc.data();

                const inicial = data.inicial || 0;
                const vendido = data.vendido || 0;
                const nombre = data.nombre || "";

                const disponible = Math.max(inicial - vendido, 0);

                // actualizar nombre
                const inputNombre = document.querySelector(
                  `input[data-nombre='${id}']`
                );
                if(inputNombre){
                  inputNombre.value = nombre;
                }

                // actualizar INI
                const inputIni = document.querySelector(
                  `input[data-stock='${id}']`
                );
                if(inputIni){
                  inputIni.value = inicial;
                }

                // actualizar DISP
                const span = document.getElementById("disp_"+id);
                if(span){
                  span.innerText = disponible;
                  span.style.color = disponible<=0 ? "red" : "black";
                }

              });

            }

          }



          function obtenerCantidad(texto){
            return parseInt(texto.split(" - ")[0]);
          }



          /* =================================================
            CANTIDADES FIJAS (LO √öNICO NUEVO)
          ================================================= */
          const TOTAL_ENTRADAS = 5;
          const TOTAL_SEGUNDOS = 10;


          /* =================================================
            EXTRAS Y ENVASES (INTOCABLES ‚Äì IGUAL QUE TUYO)
          ================================================= */
          const extrasComida=[
          {nombre:"Arroz extra",precio:2},
          {nombre:"Presa adicional",precio:5},
          {nombre:"Vaso adicional",precio:1},
          {nombre:"Medio vaso refresco",precio:0.5}
          ];

          const envases=[
          {nombre:"Taper grande",precio:1},
          {nombre:"Taper chico",precio:0.5}
          ];

          let pedidos = [];
          let vistaActual = "meseros";
          let mostrarAtendidos = false;

          db.collection("pedidos").doc("diaActual")
          .onSnapshot((doc) => {

            if(!doc.exists) return;

            const nuevaLista = doc.data().lista || [];

            // üî• SOLO redibujar si cambi√≥ cantidad de pedidos
            if(nuevaLista.length !== pedidos.length){

              pedidos = nuevaLista;
              mostrar();

            } else {

              // üî• SOLO actualizar datos sin reconstruir HTML
              pedidos = nuevaLista;

            }

          });

          /* =================================================
            NUEVO: CREAR ENTRADAS/SEGUNDOS EDITABLES
            (MISMO DISE√ëO .item .controls .qty)
          ================================================= */
          function crearMenuEditable(total, cont, prefijo){

            const div=document.getElementById(cont);

            for(let i=0;i<total;i++){

              const key=prefijo+i;
          
                const disponible = 0;

              div.innerHTML+=`
            <div class="item" style="display:flex;align-items:center;gap:10px">

              <!-- INICIAL -->
              <input
                class="colIni"
                type="number"
                min="0"
                data-stock="${key}"
                oninput="actualizarInicialFirestore('${prefijo}','${key}',this.value)"
              >





              <!-- DISPONIBLE -->
              <span
                id="disp_${key}"
                style="width:60px;text-align:center;font-weight:bold;color:${disponible<=0?'red':'black'}">
                ${disponible}
              </span>


              <!-- NOMBRE -->
              <input class="nombrePlato"
                data-nombre="${key}"
                data-seccion="${prefijo === 'E' ? 'entradas' : 'segundos'}"
                placeholder="Nombre..."
                oninput="actualizarNombreFirestore(this)"
                style="flex:1"
              >


              <!-- CONTROLES -->
              <div class="controls">

                <button onclick="cambiar('${key}',-1)">-</button>

                <input class="qty" id="${key}" value="0" readonly>

                <button onclick="cambiar('${key}',1)">+</button>

                <!-- BOT√ìN NOTA -->
                <button 
                  type="button"
                  onclick="toggleNota('${key}')"
                  style="
                    background:#eee;
                    padding:6px 8px;
                    border-radius:6px;
                    font-size:12px;
                  ">
                  üìù
                </button>

              </div>

            </div>

            <!-- NOTA OCULTA -->
            <input
              id="nota_${key}"
              placeholder="Nota (sin arroz, sin papa, etc)"
              style="
                display:none;
                margin-top:5px;
                font-size:12px;
                padding:4px;
                border:1px solid #ddd;
                border-radius:6px;
                width:100%;
              ">
          `;

            }
          }





          /* =================================================
            CREAR ITEMS (AHORA CON NOTA POR PLATO)
          ================================================= */
          function crearItems(lista, cont){
            const div=document.getElementById(cont);

            lista.forEach(i=>{
              const nombre=i.nombre||i;

              div.innerHTML+=`
                <div class="item">
                  ${nombre} ${i.precio?`(S/ ${i.precio})`:""}
                  <div class="controls">
                    <button onclick="cambiar('${nombre}',-1)">-</button>
                    <input class="qty" id="${nombre}" value="0" readonly>
                    <button onclick="cambiar('${nombre}',1)">+</button>
                  </div>
                </div>`;
            });
          }




          /* =================================================
            + / -  (TUYO)
          ================================================= */
          function cambiar(id,n){
            const el=document.getElementById(id);
            let v=parseInt(el.value)+n;
            if(v<0)v=0;
            el.value=v;
            calcularPreview(); // üëà agregado
          }


          function calcularPreview(){

            let total=0;
            let ent=0, seg=0;

            // contar entradas
            for(let i=0;i<TOTAL_ENTRADAS;i++){
              ent += +document.getElementById("E"+i).value;
            }

            // contar segundos
            for(let i=0;i<TOTAL_SEGUNDOS;i++){
              seg += +document.getElementById("S"+i).value;
            }

            const menus=Math.min(ent,seg);

            total+=menus*13;
            total+=(seg-menus)*10;
            total+=(ent-menus)*5;

            // extras
            extrasComida.forEach(e=>{
              total += +document.getElementById(e.nombre).value * e.precio;
            });

            // envases
            envases.forEach(e=>{
              total += +document.getElementById(e.nombre).value * e.precio;
            });

            // delivery
            total += +deliveryCosto.value;

            totalPreview.innerText="S/ "+total.toFixed(2);
          }

          function toggleNota(id){

            const campo = document.getElementById("nota_"+id);

            if(campo.style.display === "none"){
              campo.style.display = "block";
              campo.focus();
            } else {
              campo.style.display = "none";
            }

          }



          /* üî• FUNCI√ìN PARA MOSTRAR / OCULTAR COLUMNA INI */
          function toggleIni(seccion){

            const container = document.getElementById(seccion);
            const card = container.closest(".card");
            const columnas = card.querySelectorAll(".colIni");

            let oculto = columnas[0].style.display !== "none";

            columnas.forEach(col=>{
              col.style.display = oculto ? "none" : "";
            });

            // üî• guardar estado
            localStorage.setItem("iniOculto_"+seccion, oculto ? "1" : "0");
          }

          function guardarTipo(){

            const selectTipo = document.getElementById("tipo");
            const tipo = selectTipo.value;

            localStorage.setItem("tipoSeleccionado", tipo);

            const contenedor = document.getElementById("mesasBotones");

            if(tipo === "mesa"){
              contenedor.style.display = "block";
              generarBotonesMesas();
            }else{
              contenedor.style.display = "none";
            }
          }


          function generarBotonesMesas(){

            const contenedor = document.getElementById("mesasBotones");
            contenedor.innerHTML = "";

            for(let i=1;i<=25;i++){

              contenedor.innerHTML += `
                <button 
                  type="button"
                  onclick="seleccionarMesa(${i})"
                  style="
                    margin:4px;
                    padding:8px 12px;
                    border-radius:8px;
                    background:#eee;
                  ">
                  ${i}
                </button>
              `;
            }
          }

          function seleccionarMesa(numero){
            document.getElementById("mesa").value = numero;
          }


          function eliminarTodo(){

            if(!confirm("¬øEliminar TODOS los pedidos del d√≠a?")) return;

            pedidos = [];
            localStorage.removeItem("pedidosMisti");

            mostrar();

            alert("Todos los pedidos fueron eliminados");
          }

          function cambiarTipo(valor){

            const select = document.getElementById("tipo");
            select.value = valor;

            // dispara tu funci√≥n original
            guardarTipo();

            actualizarBotonesTipo();
          }

          function actualizarBotonesTipo(){

            const valor = document.getElementById("tipo").value;

            document.querySelectorAll(".tipoSelector button")
              .forEach(btn => btn.classList.remove("activo"));

            if(valor === "mesa") document.getElementById("btnMesa").classList.add("activo");
            if(valor === "llevar") document.getElementById("btnLlevar").classList.add("activo");
            if(valor === "reserva") document.getElementById("btnReserva").classList.add("activo");
          }




          /* =================================================
            REGISTRAR (MISMA L√ìGICA + solo cambio de lectura)
          ================================================= */
          function registrarPedido(){

            let total=0;
            let ent=0, seg=0;

            let detalleEntradas=[];
            let detalleSegundos=[];
            let detalleExtras=[];
            let detalleEnvases=[];

            /* ENTRADAS */
            for(let i=0;i<TOTAL_ENTRADAS;i++){
              const nombre = document.querySelector(`input[data-nombre='E${i}']`)?.value;
              const c=+document.getElementById("E"+i).value;

              if(nombre && c>0){

                const nota=document.getElementById("nota_E"+i)?.value || "";

                let texto=`${c} - ${nombre}`;
                db.collection("stock")
                  .doc("entradas")
                  .collection("items")
                  .doc("E"+i)
                  .set({
                    vendido: firebase.firestore.FieldValue.increment(c)
                  }, { merge:true });


                if(nota) texto+=` | NOTA: ${nota.toUpperCase()}`;

                detalleEntradas.push(texto);
                ent+=c;
              }

            }

            /* SEGUNDOS */
            for(let i=0;i<TOTAL_SEGUNDOS;i++){
              const nombre = document.querySelector(`input[data-nombre='S${i}']`)?.value;
              const c=+document.getElementById("S"+i).value;

              if(nombre && c>0){

                const nota=document.getElementById("nota_S"+i)?.value || "";

                let texto=`${c} - ${nombre}`;
                db.collection("stock")
                  .doc("segundos")
                  .collection("items")
                  .doc("S"+i)
                  .set({
                    vendido: firebase.firestore.FieldValue.increment(c)
                  }, { merge:true });


                if(nota) texto+=` | NOTA: ${nota.toUpperCase()}`;

                detalleSegundos.push(texto);
                seg+=c;
              }

            }

            const menus=Math.min(ent,seg);

            total+=menus*13;
            total+=(seg-menus)*10;
            total+=(ent-menus)*5;

            /* EXTRAS (IGUAL) */
            extrasComida.forEach(e=>{
              const c=+document.getElementById(e.nombre).value;
              if(c>0){
                detalleExtras.push(`${c} - ${e.nombre}`);
                total+=c*e.precio;
              }
            });

            /* ENVASES (IGUAL) */
            envases.forEach(e=>{
              const c=+document.getElementById(e.nombre).value;
              if(c>0){
                detalleEnvases.push(`${c} - ${e.nombre}`);
                total+=c*e.precio;
              }
            });

            const delivery=+deliveryCosto.value;
            total+=delivery;

          if(detalleEntradas.length===0 && detalleSegundos.length===0){
            alert("No hay platos en el pedido");
            return;
          }


          const tipoActual = document.getElementById("tipo").value;

          let horaExacta = null;
          let timestamp = null;

          if(tipoActual === "mesa"){
            const ahora = new Date();

            // Hora bonita para mostrar
            horaExacta = ahora.toLocaleTimeString("es-PE", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit"
            });

            // Tiempo real en milisegundos (para el temporizador)
            timestamp = Date.now();
          }


          pedidos.push({
            tipo: tipoActual,
            mesa: document.getElementById("mesa").value,
            hora: horaExacta, // solo tendr√° valor si es mesa
            horaRegistro: timestamp, // ‚¨ÖÔ∏è NUEVO (para el temporizador)
            atendido: false, // ‚¨ÖÔ∏è NUEVO (para saber si ya se complet√≥)
            colapsado: false, // üëà NUEVO
            detalleEntradas: detalleEntradas,
            detalleSegundos: detalleSegundos,
            detalleExtras: detalleExtras,
            detalleEnvases: detalleEnvases,
            total: total,
          });




            guardarHistorial();
            mostrar();
            reset();
          }


          /* =================================================
            TODO LO DEM√ÅS IGUAL (MOSTRAR / ELIMINAR / ETC)
          ================================================= */

          function mostrar(){

            if(vistaActual === "cocina"){
              mostrarCocina();
              return;
            }

            if(vistaActual === "clientes"){
              mostrarClientes();
              return;
            }


            console.log("Array pedidos actual:", pedidos);

            let htmlMesa="";
            let htmlReserva="";
            let htmlLlevar="";

            let htmlMesaPendientes = "";
            let htmlMesaAtendidos = "";

            // üî• ORDEN VISUAL SEGURO (sin tocar el array)
            const ordenIndices = [
              ...pedidos.map((p,i)=> !p.atendido ? i : null).filter(i=>i!==null),
              ...pedidos.map((p,i)=> p.atendido ? i : null).filter(i=>i!==null)
            ];

            ordenIndices.forEach((i)=>{

              const p = pedidos[i];

              let bloque=`
              <div class="pedido" id="pedido_${i}">

              <b>
              #${i+1} | ${p.tipo.toUpperCase()} | ${(p.mesa||"-").toUpperCase()}
              ${p.tipo === "mesa" && p.hora ? ` | üïí ${p.hora}` : ""}
              </b>
              `;

              if(p.tipo === "mesa"){

                bloque += `
                <div style="display:flex;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap">

                  ‚è± Tiempo: 
<span class="timer"
      data-hora="${p.horaRegistro || ''}"
      data-atendido="${p.atendido ? '1' : '0'}"
      data-tiempofinal="${p.tiempoFinal || ''}"
      style="font-weight:bold;color:#c40000">
${p.tiempoFinal ? p.tiempoFinal : "00:00"}
</span>

                  ${!p.atendido ? `
                  <button onclick="marcarAtendido(${i})" 
                    style="background:green;color:white">
                    ‚úÖ ATENDIDO
                  </button>
                  ` : `
                  <button onclick="toggleColapsado(${i})"
                    style="background:#6c757d;color:white">
                    ${p.colapsado ? "üîΩ Ver" : "üîº Ocultar"}
                  </button>
                  `}

                  <button onclick="editarPedido(${i})"
                    style="background:#2196F3;color:white">
                    ‚úèÔ∏è EDITAR
                  </button>

                  <button onclick="eliminar(${i})"
                    style="background:black;color:white">
                    üóëÔ∏è
                  </button>

                </div>
                <br>
                `;

              } else {

                if(p.tipo === "reserva"){
                  bloque += `
                    <button onclick="pasarAMesa(${i})"
                      style="background:#4CAF50;color:white;margin-right:6px">
                      ‚ûú Pasar a Mesa
                    </button>
                  `;
                }

                bloque += `
                  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">

                    <button onclick="editarPedido(${i})"
                      style="background:#2196F3;color:white">
                      ‚úèÔ∏è
                    </button>

                    <button onclick="eliminar(${i})"
                      style="background:black;color:white">
                      üóëÔ∏è
                    </button>

                  </div>
                  <br>
                  `;

              }

                if(p.convertidoDesde === "reserva"){
                  bloque += `
                    <div style="
                      background:#ff9800;
                      color:white;
                      padding:6px;
                      margin-top:6px;
                      font-weight:bold;
                      border-radius:4px;
                    ">
                      ‚ö†Ô∏è RESERVA: ${p.nombreReserva}
                    </div>
                  `;
                }



              if(!p.colapsado || p.atendido){

                if(p.detalleEntradas.length)
                  bloque+=`<b>Entradas:</b><br>${
                    dibujarItemsMesero(p.detalleEntradas, i, "entrada")
                  }<br>`;

                if(p.detalleSegundos.length)
                  bloque+=`<b>Segundos:</b><br>${
                    dibujarItemsMesero(p.detalleSegundos, i, "segundo")
                  }<br>`;

                if(p.detalleExtras.length)
                  bloque+=`<b>Extras:</b><br>${p.detalleExtras.join("<br>")}<br><br>`;

                if(p.detalleEnvases.length)
                  bloque+=`<b>Envases:</b><br>${p.detalleEnvases.join("<br>")}<br><br>`;

                bloque+=`<b>Total: S/ ${p.total.toFixed(2)}</b>`;
              }

              bloque+=`</div>`;

                if(p.tipo==="mesa"){

                  if(p.atendido){
                    htmlMesaAtendidos += bloque;
                  } else {
                    htmlMesaPendientes += bloque;
                  }

                }
              if(p.tipo==="reserva") htmlReserva+=bloque;
              if(p.tipo==="llevar") htmlLlevar+=bloque;

            });

            document.getElementById("seccion_mesa").innerHTML = `

              ${htmlMesaPendientes}

              ${htmlMesaAtendidos ? `
                <div style="margin-top:20px;text-align:center">
                  <button onclick="toggleAtendidos()"
                    style="padding:8px 14px;border-radius:8px;background:#444;color:white">
                    üìÇ Ver pedidos atendidos
                  </button>

                  <div id="listaAtendidos" style="display:${mostrarAtendidos ? 'block' : 'none'};margin-top:15px">
                    ${htmlMesaAtendidos}
                  </div>
                </div>
              ` : ""}

            `;
            document.getElementById("seccion_reserva").innerHTML=htmlReserva;
            document.getElementById("seccion_llevar").innerHTML=htmlLlevar;
            
            mostrarSeccionPedidos("mesa");
          }


          function mostrarSeccionPedidos(tipo){

            let titulo = "";
            let contenido = "";

            if(tipo === "mesa"){
              titulo = "üçΩÔ∏è Mesa";
              contenido = document.getElementById("seccion_mesa").innerHTML;
            }

            if(tipo === "reserva"){
              titulo = "üìÖ Reserva";
              contenido = document.getElementById("seccion_reserva").innerHTML;
            }

            if(tipo === "llevar"){
              titulo = "ü•° Llevar";
              contenido = document.getElementById("seccion_llevar").innerHTML;
            }

            document.getElementById("contenedorPedidos").innerHTML = `
              <h3>
                ${titulo}
                <button class="btn" onclick="descargarWordTipo('${tipo}')">
                  üìÑ Imprimir
                </button>
              </h3>
              ${contenido}
            `;

            // activar bot√≥n visual
            document.querySelectorAll("#btnMesaPedidos,#btnReservaPedidos,#btnLlevarPedidos")
              .forEach(b=>b.classList.remove("activo"));

            if(tipo==="mesa") document.getElementById("btnMesaPedidos").classList.add("activo");
            if(tipo==="reserva") document.getElementById("btnReservaPedidos").classList.add("activo");
            if(tipo==="llevar") document.getElementById("btnLlevarPedidos").classList.add("activo");

          }


          function eliminar(index){
            if(confirm("¬øEliminar este pedido?")){
              pedidos.splice(index,1);
              guardarHistorial();
              mostrar();
            }
          }

          function editarPedido(index){

            const p = pedidos[index];

            if(!confirm("Editar este pedido?")) return;

            // üî• 1. DEVOLVER STOCK
            p.detalleEntradas.forEach(item=>{
              const partes = item.split(" - ");
              const cantidad = parseInt(partes[0]);
              const nombre = partes[1]?.split("|")[0].trim();

              for(let i=0;i<TOTAL_ENTRADAS;i++){
                const inputNombre = document.querySelector(`input[data-nombre='E${i}']`);
                if(inputNombre && inputNombre.value === nombre){
                  db.collection("stock")
                    .doc("entradas")
                    .collection("items")
                    .doc("E"+i)
                    .set({
                      vendido: firebase.firestore.FieldValue.increment(-cantidad)
                    }, { merge:true });
                }
              }
            });

            p.detalleSegundos.forEach(item=>{
              const partes = item.split(" - ");
              const cantidad = parseInt(partes[0]);
              const nombre = partes[1]?.split("|")[0].trim();

              for(let i=0;i<TOTAL_SEGUNDOS;i++){
                const inputNombre = document.querySelector(`input[data-nombre='S${i}']`);
                if(inputNombre && inputNombre.value === nombre){
                  db.collection("stock")
                    .doc("segundos")
                    .collection("items")
                    .doc("S"+i)
                    .set({
                      vendido: firebase.firestore.FieldValue.increment(-cantidad)
                    }, { merge:true });
                }
              }
            });

          // üî• 1. limpiar primero
          reset();

          // üî• 2. luego cargar datos
          document.getElementById("tipo").value = p.tipo;
          document.getElementById("mesa").value = p.mesa;

          // activar botones visuales
          guardarTipo();
          actualizarBotonesTipo();

            // rellenar entradas
            p.detalleEntradas.forEach(item=>{
              const partes = item.split(" - ");
              const cantidad = parseInt(partes[0]);
              const nombre = partes[1]?.split("|")[0].trim();

              for(let i=0;i<TOTAL_ENTRADAS;i++){
                const inputNombre = document.querySelector(`input[data-nombre='E${i}']`);
                if(inputNombre && inputNombre.value === nombre){
                  document.getElementById("E"+i).value = cantidad;
                }
              }
            });

            // rellenar segundos
            p.detalleSegundos.forEach(item=>{
              const partes = item.split(" - ");
              const cantidad = parseInt(partes[0]);
              const nombre = partes[1]?.split("|")[0].trim();

              for(let i=0;i<TOTAL_SEGUNDOS;i++){
                const inputNombre = document.querySelector(`input[data-nombre='S${i}']`);
                if(inputNombre && inputNombre.value === nombre){
                  document.getElementById("S"+i).value = cantidad;
                }
              }
            });

            // üî• 3. ELIMINAR PEDIDO ORIGINAL
            pedidos.splice(index,1);
            guardarHistorial();
            mostrar();

            calcularPreview();
          }


          function guardarHistorial(){
            db.collection("pedidos").doc("diaActual").set({
              lista: pedidos
            });
          }

          function reset(){

            // üî• Solo reiniciar cantidades del pedido
            document.querySelectorAll(".qty").forEach(e=>e.value=0);

            // limpiar notas
            document.querySelectorAll("[id^='nota_E']").forEach(e=>e.value="");
            document.querySelectorAll("[id^='nota_S']").forEach(e=>e.value="");

            // NO tocar nombres
            // NO tocar INICIAL
            // NO tocar stock

            deliveryCosto.value=0;

            calcularPreview();
          }

          function resetearDisponibles(){

            if(!confirm("¬øResetear todos los DISPONIBLES?")) return;

            for(let i=0;i<TOTAL_ENTRADAS;i++){
              db.collection("stock")
                .doc("entradas")
                .collection("items")
                .doc("E"+i)
                .set({ vendido:0 }, { merge:true });
            }

            for(let i=0;i<TOTAL_SEGUNDOS;i++){
              db.collection("stock")
                .doc("segundos")
                .collection("items")
                .doc("S"+i)
                .set({ vendido:0 }, { merge:true });
            }

          }




          function calcularTiempoFinal(inicio){

            const ahora = Date.now();
            const diff = ahora - inicio;

            const minutos = Math.floor(diff / 60000);
            const segundos = Math.floor((diff % 60000) / 1000);

            return `${minutos.toString().padStart(2,"0")}:${segundos.toString().padStart(2,"0")}`;
          }

          function marcarAtendido(index){

            const ahora = Date.now();
            const inicio = pedidos[index].horaRegistro;

            const diff = ahora - inicio;

            const minutos = Math.floor(diff / 60000);
            const segundos = Math.floor((diff % 60000) / 1000);

            pedidos[index].tiempoFinal =
              `${minutos.toString().padStart(2,"0")}:`+
              `${segundos.toString().padStart(2,"0")}`;

            pedidos[index].atendido = true;
            pedidos[index].colapsado = true;

            // ‚ùå ELIMINAMOS ESTO:
            // const pedidoFinalizado = pedidos.splice(index,1)[0];
            // pedidos.push(pedidoFinalizado);

            guardarHistorial();
            mostrar();
          }






          function toggleColapsado(index){
            pedidos[index].colapsado = !pedidos[index].colapsado;
            guardarHistorial();
            mostrar();
          }

            function toggleAtendidos(){
              mostrarAtendidos = !mostrarAtendidos;
              mostrar();
            }


          function pasarAMesa(index){

            const numeroMesa = prompt("N√∫mero de mesa:");
            if(!numeroMesa) return;

            const ahora = new Date();
            const horaExacta = ahora.toLocaleTimeString("es-PE", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit"
            });

            // üî• GUARDAR EL NOMBRE ORIGINAL CORRECTAMENTE
            pedidos[index].convertidoDesde = "reserva";
            pedidos[index].nombreReserva = pedidos[index].mesa;

            // üî• CAMBIAR A MESA
            pedidos[index].tipo = "mesa";
            pedidos[index].mesa = numeroMesa;
            pedidos[index].hora = horaExacta;
            pedidos[index].horaRegistro = Date.now();
            pedidos[index].atendido = false;
            pedidos[index].colapsado = false;

            guardarHistorial();
            mostrar();
          }


          function actualizarInicialFirestore(prefijo,id,valor){

            const seccion = prefijo === "E" ? "entradas" : "segundos";

            db.collection("stock")
              .doc(seccion)
              .collection("items")
              .doc(id)
              .set({
                inicial: parseInt(valor) || 0
              }, { merge:true });

          }


          function actualizarNombreFirestore(input){

            const id = input.dataset.nombre;
            const seccion = input.dataset.seccion;
            const valor = input.value;

            db.collection("stock")
              .doc(seccion)
              .collection("items")
              .doc(id)
              .set({
                nombre: valor
              }, { merge:true });

          }


          /* =================================================
            INIT
          ================================================= */
          crearMenuEditable(TOTAL_ENTRADAS,"entradas","E");
          crearMenuEditable(TOTAL_SEGUNDOS,"segundos","S");

          escucharStock("entradas", TOTAL_ENTRADAS, "E");
          escucharStock("segundos", TOTAL_SEGUNDOS, "S");

          // üî• aplicar estado guardado
          ["entradas","segundos"].forEach(seccion=>{
            const oculto = localStorage.getItem("iniOculto_"+seccion);
            if(oculto === "1"){
              toggleIni(seccion);
            }
          });


          crearItems(extrasComida,"extrasComida");
          crearItems(envases,"envases");

          mostrar();
          actualizarBotonesTipo();


          // üî• TEMPORIZADOR GLOBAL (actualiza cada segundo)
setInterval(() => {

  document.querySelectorAll(".timer").forEach(timer => {

    const hora = timer.dataset.hora;
    const atendido = timer.dataset.atendido;

    if (atendido === "1") {

    const final = timer.dataset.tiempofinal;
    if (final) {
      timer.textContent = final;
    }

    return;
  }

  if (!hora) return;

    const diff = Date.now() - Number(hora);

    const minutos = Math.floor(diff / 60000);
    const segundos = Math.floor((diff % 60000) / 1000);

    const tiempo =
      minutos.toString().padStart(2,"0") + ":" +
      segundos.toString().padStart(2,"0");

    timer.textContent = tiempo;

    // üî• PINTAR EL CUADRITO SEG√öN URGENCIA
      const pedidoBox = timer.closest(".pedido");

      if (pedidoBox) {

        if (minutos < 5) {
          pedidoBox.style.background = "#C8E6C9";   // verde suave
        } 
        else if (minutos < 10) {
          pedidoBox.style.background = "#FFF9C4";   // amarillo suave
        } 
        else {
          pedidoBox.style.background = "#FFCDD2";   // rojo suave
        }

        pedidoBox.style.color = "black";  // mantener letras negras
      }

  });

}, 1000);


          // üî• restaurar tipo guardado
          const tipoGuardado = localStorage.getItem("tipoSeleccionado");
          if(tipoGuardado){
            document.getElementById("tipo").value = tipoGuardado;
          }

          guardarTipo();
          actualizarBotonesTipo();

          // üî• restaurar vista guardada
          const vistaGuardada = localStorage.getItem("vistaActualMisti");
          if(vistaGuardada){
            vistaActual = vistaGuardada;
          }

          cambiarVista(vistaActual);

          deliveryCosto.addEventListener("input",calcularPreview);

          async function descargarWordTipo(tipoFiltrado){

            const pedidosFiltrados = pedidos.filter(p=>p.tipo===tipoFiltrado);

            if(pedidosFiltrados.length===0){
              alert("No hay pedidos en esta secci√≥n");
              return;
            }

            const {
              Document,
              Packer,
              Paragraph,
              TextRun,
              Table,
              TableRow,
              TableCell,
              WidthType,
              BorderStyle
            } = docx;

            const COLUMNAS = 6;

            let columnasPedidos = Array.from({length:COLUMNAS},()=>[]);

            pedidosFiltrados.forEach((p,i)=>{
              columnasPedidos[i % COLUMNAS].push(p);
            });

            const filas = [];
            const maxFilas = Math.max(...columnasPedidos.map(c=>c.length));

            for(let f=0; f<maxFilas; f++){

              const rowCells = [];

              for(let c=0; c<COLUMNAS; c++){

                const pedido = columnasPedidos[c][f];

                if(pedido){

                  const contenido = [];

                  contenido.push(
                    new Paragraph({
                      children:[
                        new TextRun({
                          text:(pedido.mesa||"SIN NOMBRE").toUpperCase(),
                          bold:true,
                          size:30
                        })
                      ],
                      spacing:{ after:100 }
                    })
                  );

                  pedido.detalleEntradas.forEach(l=>{
                    contenido.push(
                      new Paragraph({
                        children:[ new TextRun({ text:l, size:24 }) ]
                      })
                    );
                  });

                  pedido.detalleSegundos.forEach(l=>{
                    contenido.push(
                      new Paragraph({
                        children:[ new TextRun({ text:l, size:24 }) ]
                      })
                    );
                  });

                  rowCells.push(
                    new TableCell({
                      width:{ size:100/COLUMNAS, type:WidthType.PERCENTAGE },
                      margins:{ top:100, bottom:100, left:150, right:150 },
                      borders:{
                        left:{style:BorderStyle.SINGLE, size:4, color:"cccccc"},
                        right:{style:BorderStyle.SINGLE, size:4, color:"cccccc"},
                        top:{style:BorderStyle.NONE},
                        bottom:{style:BorderStyle.NONE}
                      },
                      children:contenido
                    })
                  );

                } else {

                  rowCells.push(
                    new TableCell({
                      width:{ size:100/COLUMNAS, type:WidthType.PERCENTAGE },
                      children:[new Paragraph("")]
                    })
                  );

                }

              }

              filas.push(new TableRow({ children: rowCells }));

            }

            const tabla = new Table({
              width:{ size:100, type:WidthType.PERCENTAGE },
              rows: filas
            });

            const doc = new Document({
              sections:[{
                properties:{
                  page:{
                    size:{ orientation:"landscape" },
                    margin:{ top:250, right:250, bottom:250, left:250 }
                  }
                },
                children:[tabla]
              }]
            });

            const blob = await Packer.toBlob(doc);

            const link=document.createElement("a");
            link.href=URL.createObjectURL(blob);
            link.download="Pedidos-"+tipoFiltrado+"-ElMisti.docx";
            link.click();
          }




          </script>

</div>

<div id="vista_cocina" style="display:none">
  <h2>üë®‚Äçüç≥ Cocina</h2>
  <div id="cocina_contenido"></div>
</div>

<div id="vista_clientes" style="display:none">
  <h2 style="text-align:center">üçΩÔ∏è Pedidos en Proceso</h2>
  <div style="text-align:center;font-size:80px;font-weight:bold" id="contador_clientes">0</div>
</div>

</div>
          </body>
          </html>
